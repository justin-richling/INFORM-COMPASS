<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CESM Run Matrix</title>

  <link rel="stylesheet" href="style.css">

  <style>
    .highlight {
      background-color: yellow;
    }

    .pagination {
      margin-top: 10px;
    }

    .pagination button {
      margin-right: 5px;
    }

    tr.detail-row {
      display: none;
    }

    tr.master-row {
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="header-bar">
  <h1>INFORM/COMPASS CESM Run Matrix</h1>
  <div><em>Last updated:</em> <span id="last-updated"></span></div>
</div>

<div style="margin-bottom:10px;">
  <input
    type="text"
    id="search-box"
    placeholder="Search run names (highlight only)"
    style="width:300px;"
  >
</div>

<div id="run-count" style="margin-bottom:10px; font-weight:bold;"></div>

<table id="matrix" border="1" cellspacing="0" cellpadding="6" width="100%">
  <thead>
    <tr>
      <th>Run Name</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination">
  <button id="prev-page">Prev</button>
  <button id="next-page">Next</button>
</div>

<script>
const ROWS_PER_PAGE = 13;
let currentPage = 1;
let masterRows = [];

const tableBody = document.querySelector("#matrix tbody");
const countEl = document.getElementById("run-count");

// ---------------- Tooltips ----------------
const tooltips = {
  "nudge_uprof": "Selectively apply nudging to U",
  "nudge_ucoef": "Nudging strength for U"
};

// ---------------- Helpers ----------------
function wrapTooltip(text) {
  const key = text.split("=")[0].trim();
  return tooltips[key]
    ? `<span class="tooltip" title="${tooltips[key]}">${text}</span>`
    : text;
}

function renderPage() {
  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const end = start + ROWS_PER_PAGE;

  masterRows.forEach((row, idx) => {
    const show = idx >= start && idx < end;
    row.master.style.display = show ? "" : "none";
    row.detail.style.display = "none";
  });

  const total = masterRows.length;
  const shownStart = Math.min(start + 1, total);
  const shownEnd = Math.min(end, total);

  countEl.textContent = `Showing ${shownStart}â€“${shownEnd} of ${total} runs`;
}

// ---------------- Fetch Data ----------------
fetch(`run_matrix.json?ts=${Date.now()}`)
  .then(r => r.json())
  .then(data => {

    data.forEach(run => {
      const master = document.createElement("tr");
      master.className = "master-row";
      master.innerHTML = `<td>${run.run_name}</td>`;

      const detail = document.createElement("tr");
      detail.className = "detail-row";
      detail.innerHTML = `
        <td>
          <strong>Nudging:</strong> ${run.nudging}<br>
          <strong>COSP:</strong> ${run.cosp}<br><br>
          <strong>FINCL:</strong><br>
          ${Object.keys(run.fincl || {}).map(wrapTooltip).join(", ")}<br><br>
          <strong>Nudged Vars:</strong><pre>${(run.nudged_vars || []).map(wrapTooltip).join("\n")}</pre>
          <strong>COSP Vars:</strong><pre>${(run.cosp_vars || []).map(wrapTooltip).join("\n")}</pre>
          <strong>Other Vars:</strong><pre>${(run.other_vars || []).map(wrapTooltip).join("\n")}</pre>
        </td>
      `;

      master.addEventListener("click", () => {
        detail.style.display = detail.style.display === "none" ? "" : "none";
      });

      tableBody.appendChild(master);
      tableBody.appendChild(detail);

      masterRows.push({ master, detail });
    });

    renderPage();
  });

// ---------------- Pagination ----------------
document.getElementById("prev-page").onclick = () => {
  if (currentPage > 1) {
    currentPage--;
    renderPage();
  }
};

document.getElementById("next-page").onclick = () => {
  const maxPage = Math.ceil(masterRows.length / ROWS_PER_PAGE);
  if (currentPage < maxPage) {
    currentPage++;
    renderPage();
  }
};

// ---------------- Search (HIGHLIGHT ONLY) ----------------
document.getElementById("search-box").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();

  masterRows.forEach(({ master }) => {
    const td = master.querySelector("td");
    td.classList.remove("highlight");

    if (q && td.textContent.toLowerCase().includes(q)) {
      td.classList.add("highlight");
    }
  });
});

// ---------------- Last Updated ----------------
fetch("run_matrix.json", { method: "HEAD" })
  .then(r => {
    const d = new Date(r.headers.get("Last-Modified"));
    document.getElementById("last-updated").textContent =
      `GMT: ${d.toUTCString()} | Local: ${d.toLocaleString()}`;
  });
</script>

</body>
</html>
