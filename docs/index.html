<!DOCTYPE html>
<html lang="en">
<head>
  <base href="./">
  <meta charset="UTF-8">
  <title>CESM Run Matrix</title>

  <link rel="stylesheet" href="style.css">

  <style>
    /* =============================
       Base table styling
       ============================= */

    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ccc;
      table-layout: fixed;
    }

    th, td {
      padding: 8px 10px;
      vertical-align: top;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: #f3f3f3;
      font-weight: 600;
      white-space: nowrap;
    }

    /* =============================
       Master / detail rows
       ============================= */

    tr.master-row {
      cursor: pointer;
      font-weight: 600;
      background: #fff;
    }

    tr.master-row:hover {
      background: #f0f6ff;
    }

    tr.detail-row {
      display: none;
    }

    tr.detail-row td {
      background: #fafafa;
      padding: 10px;
    }

    /* =============================
       Nested table styling
       ============================= */

    table.nested {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      border: 1px solid #bbb;
    }

    table.nested th,
    table.nested td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      vertical-align: top;
    }

    table.nested th {
      background: #e9e9e9;
      font-size: 0.9em;
    }

    /* Column sizing for nested table */
    table.nested th:nth-child(1),
    table.nested td:nth-child(1) { width: 10%; }

    table.nested th:nth-child(2),
    table.nested td:nth-child(2) { width: 10%; }

    table.nested th:nth-child(3),
    table.nested td:nth-child(3) { width: 15%; }

    table.nested th:nth-child(4),
    table.nested td:nth-child(4),
    table.nested th:nth-child(5),
    table.nested td:nth-child(5),
    table.nested th:nth-child(6),
    table.nested td:nth-child(6) {
      width: 21%;
    }

    /* =============================
       Preformatted blocks
       ============================= */

    pre {
      margin: 0;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    /* =============================
       Tooltip styling
       ============================= */

    .tooltip {
      color: #1a73e8;
      cursor: help;
      position: relative;
    }

    .tooltip:hover::after {
      content: attr(data-tooltip);
      white-space: pre-wrap;
      position: absolute;
      left: 0;
      top: 1.5em;
      background: #333;
      color: #fff;
      padding: 6px 8px;
      font-size: 12px;
      z-index: 10;
      max-width: 400px;
      border-radius: 4px;
    }

    /* =============================
       Search + pagination
       ============================= */

    .highlight {
      background: yellow;
    }

    #pagination {
      margin-top: 12px;
    }

    #pagination button {
      margin: 0 3px;
      padding: 4px 8px;
    }
  </style>
</head>

<body>

<div id="header-bar">
  <div><h1>INFORM/COMPASS CESM Run Matrix</h1></div>
  <div><em>Last updated:</em> <span id="last-updated"></span></div>
</div>

<div style="margin: 10px 0;">
  <label>
    Search run name:
    <input type="text" id="search-input" placeholder="Type to highlightâ€¦">
  </label>
</div>

<div id="run-count"></div>

<table id="matrix">
  <thead>
    <tr>
      <th>Run Name</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="pagination"></div>

<!-- JS unchanged -->
<script>
const tooltips = {
      "nudge_uprof": "Selectively apply nudging to U:\nOFF = Switch off nudging\nON = Apply nudging everywhere\nWINDOW = Apply window function to nudging tendencies.\n0 = OFF\n1 = ON\n2 = WINDOW",
      "nudge_ucoef": "Selectively adjust the nudging strength applied to U. (normalized) [0.,1.]",
      "nudge_hwin_lat0": "Specify the horizontal center of the window (lat0) in degrees. [-90., +90.]",
      "nudge_hwin_lon0": "Specify the horizontal center of the window (lon0) in degrees. [0., 360.]",
      "nudge_hwin_latwidth": "Specify the lat width of the horizontal window in degrees.\nSetting a width to a large value (e.g. 999.) renders the window constant in that direction.\n>0",
      "nudge_hwin_lonwidth": "Specify the lon width of the horizontal window in degrees.\nSetting a width to a large value (e.g. 999.) renders the window constant in that direction.\n>0",
      "nudge_vwin_hindex": "Vertical window high index",
      "nudge_vwin_lindex": "Vertical window low index",
      "nudge_vwin_hdelta": "Vertical window high delta",
      "nudge_vwin_ldelta": "Vertical window low delta",
      "nudge_vwin_invert": "A logical flag used to invert the horizontal window function to get its complement.\nTrue/False",
      "nudge_hwin_latdelta": "Horizontal lat delta",
      "nudge_hwin_londelta": "Horizontal lon delta",
      "nudge_hwin_invert": "A logical flag used to invert the horizontal window function to get its complement.\n(e.g. to nudge outside a given window)\nTrue/False",
      "nudge_timescale_opt": "Select the timescale for the relaxation:\nWEAK = Constant time scale based on the interval of Target values.\nSTRONG = Variable timescale which gets stronger near each Target time.\n0 = WEAK\n1 = STRONG",
      "nudge_force_opt": "Select the form of the Target values:\nNEXT = Target at next future time\nLINEAR = Linearly interpolate Target values to current model time.\n0 = NEXT\n1 = LINEAR"
    };

const rowsPerPage = 13;
let currentPage = 1;
let runs = [];

function wrapTooltip(text) {
  const key = text.split("=")[0].trim();
  return tooltips[key]
    ? `<span class="tooltip" data-tooltip="${tooltips[key]}">${text}</span>`
    : text;
}

function renderTable() {
  const tbody = document.querySelector("#matrix tbody");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageRuns = runs.slice(start, end);

  pageRuns.forEach(run => {
    const master = document.createElement("tr");
    master.className = "master-row";
    master.innerHTML = `<td class="run-name">${run.run_name}</td>`;
    tbody.appendChild(master);

    const detail = document.createElement("tr");
    detail.className = "detail-row";
    detail.innerHTML = `
      <td>
        <table class="nested">
          <tr>
            <th>Nudging</th>
            <th>COSP</th>
            <th>FINCL</th>
            <th>Nudged Vars</th>
            <th>COSP Vars</th>
            <th>Other Vars</th>
          </tr>
          <tr>
            <td>${run.nudging}</td>
            <td>${run.cosp}</td>
            <td>${Object.keys(run.fincl || {}).join(", ")}</td>
            <td><pre>${(run.nudged_vars||[]).map(wrapTooltip).join("\n")}</pre></td>
            <td><pre>${(run.cosp_vars||[]).map(wrapTooltip).join("\n")}</pre></td>
            <td><pre>${(run.other_vars||[]).map(wrapTooltip).join("\n")}</pre></td>
          </tr>
        </table>
      </td>
    `;
    tbody.appendChild(detail);

    master.addEventListener("click", () => {
      detail.style.display =
        detail.style.display === "table-row" ? "none" : "table-row";
    });
  });

  document.getElementById("run-count").textContent =
    `Showing ${pageRuns.length} of ${runs.length} runs`;
}

function renderPagination() {
  const pages = Math.ceil(runs.length / rowsPerPage);
  const div = document.getElementById("pagination");
  div.innerHTML = "";

  for (let i = 1; i <= pages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => {
      currentPage = i;
      renderTable();
      renderPagination();
    };
    if (i === currentPage) btn.disabled = true;
    div.appendChild(btn);
  }
}

document.getElementById("search-input").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  document.querySelectorAll(".run-name").forEach(td => {
    td.classList.toggle("highlight", q && td.textContent.toLowerCase().includes(q));
  });
});

fetch(`run_matrix.json?ts=${Date.now()}`)
  .then(r => r.json())
  .then(data => {
    runs = data;
    renderTable();
    renderPagination();
  });

fetch("run_matrix.json", { method: "HEAD" })
  .then(r => {
    const d = new Date(r.headers.get("Last-Modified"));
    document.getElementById("last-updated").textContent =
      `${d.toUTCString()} | Local: ${d.toLocaleString()}`;
  });
</script>

</body>
</html>
