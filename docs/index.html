<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CESM Run Matrix</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 5px; font-size: 0.9em; vertical-align: top; }
    td pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }

    /* Tooltip styling */
    .tooltip {
      position: relative;
      cursor: pointer;
      color: #007bff;
    }

    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 0;
      top: 100%;
      background: #333;
      color: #fff;
      padding: 6px;
      border-radius: 4px;
      white-space: pre-wrap;       /* allow line breaks and wrap text */
      word-wrap: break-word;       /* break long words if needed */
      overflow-wrap: break-word;   /* better cross-browser support */
      z-index: 100;
      width: max-content;
      max-width: 400px;            /* constrain tooltip width */
      margin-top: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: none;               /* initially hidden */
    }

    /* Show tooltip on hover */
    .tooltip:hover::after {
      display: block;
    }

    .tooltip-box {
      position: absolute;
      display: none;
      background: #222;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      max-width: 420px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      font-size: 0.85em;
    }

    .tooltip-trigger {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline dotted;
    }

  </style>
</head>
<body>
  <h1>INFORM/COMPASS CESM Run Matrix</h1>
  <div id="run-count" style="margin-bottom: 10px; font-weight: bold;">
    Showing 0 of 0 runs
  </div>

  <table id="matrix" class="display">
    <thead>
      <tr>
        <th>Run Name</th>
        <th>Nudging</th>
        <th>COSP</th>
        <th>FINCL Keys</th>
        <th>Nudged Vars</th>
        <th>COSP Vars</th>
        <th>Other Vars</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- jQuery and DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    const countEl = document.getElementById("run-count");
    let tooltips = {};

    Promise.all([
      fetch("run_matrix.json").then(r => r.json()),
      fetch("tooltips.json").then(r => r.json())
    ]).then(([data, tooltipData]) => {

      tooltips = tooltipData;
      const tableBody = document.querySelector("#matrix tbody");

      function makeTooltip(label, key) {
        const text = tooltips[key];
        if (!text) return label;

        return `
          <span class="tooltip" data-tooltip="${text}">
            ${label}
          </span>
        `;
      }

      function wrapTooltip(varString) {
        const name = varString.split("=")[0].trim().toLowerCase();
        return makeTooltip(varString, name);
      }

      data.forEach(run => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${run.run_name}</td>
          <td>${run.nudging}</td>
          <td>${run.cosp}</td>
          <td>${Object.keys(run.fincl || {}).map(wrapTooltip).join(", ")}</td>
          <td><pre>${(run.nudged_vars || []).map(wrapTooltip).join("\n")}</pre></td>
          <td><pre>${(run.cosp_vars || []).map(wrapTooltip).join("\n")}</pre></td>
          <td><pre>${(run.other_vars || []).map(wrapTooltip).join("\n")}</pre></td>
        `;
        tableBody.appendChild(tr);
      });

      const dt = $('#matrix').DataTable({
        scrollX: true,
        pageLength: 25,
        order: []
      });

      function updateCount() {
        const total = dt.rows().count();
        const shown = dt.rows({ search: 'applied' }).count();
        countEl.textContent = `Showing ${shown} of ${total} runs`;
      }

      updateCount();
      dt.on('search.dt draw.dt', updateCount);

    }).catch(err => {
      console.error(err);
      countEl.textContent = "Error loading run data";
    });

    /* Click-to-open tooltips (global, once) */
    document.addEventListener("click", e => {
      document.querySelectorAll(".tooltip-box").forEach(b => b.style.display = "none");

      const trigger = e.target.closest(".tooltip-trigger");
      if (!trigger) return;

      const box = document.getElementById(trigger.dataset.tooltipId);
      if (!box) return;

      const rect = trigger.getBoundingClientRect();
      box.style.left = `${rect.left + window.scrollX}px`;
      box.style.top = `${rect.bottom + window.scrollY + 6}px`;
      box.style.display = "block";

      e.stopPropagation();
    });
    </script>


  <p><em>Last updated:</em> <span id="last-updated"></span></p>
  <script>
    fetch("run_matrix.json", { method: "HEAD" })
      .then(r => {
        document.getElementById("last-updated").textContent =
          r.headers.get("Last-Modified");
      });
  </script>
</body>
</html>
